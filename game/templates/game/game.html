{% extends 'game/base.html' %}
{% load static %}

{% block title %}Boo의 졸업 대모험 - 게임 플레이{% endblock %}

{% block meta_description %}Boo의 졸업 대모험 게임을 플레이하세요! 장애물을 점프하여 피하고, 아이템을 수집하여 졸업을 향해 도전하세요.{% endblock %}
{% block meta_keywords %}Boo, 웹게임, 외대 게임, 졸업게임, 플랫폼게임, 장애물 게임, 점프게임, 스테이지{% endblock %}

{% block og_title %}Boo의 졸업 대모험 - 지금 플레이하세요!{% endblock %}
{% block og_description %}장애물을 피하고 F를 극복하며 기숙사에서 정문까지 Boo와 함께 졸업을 향해 달려보세요!{% endblock %}
{% block og_url %}https://boogame.kr/game/play/{% endblock %}
{% block canonical_url %}https://boogame.kr/game/play/{% endblock %}

{% block head_extra %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#121212">
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/game.css' %}">
<style>
    /* 모바일에서 터치 최적화 */
    @media (max-width: 800px) {
        html, body {
            touch-action: none;
            overflow: hidden;
            height: 100%;
            position: fixed;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* iOS에서 두 번 탭 방지 */
        .game-container {
            touch-action: manipulation;
        }
        
        /* iOS에서 입력 필드 확대 방지 */
        input {
            font-size: 16px; /* iOS에서 확대 방지를 위한 최소 폰트 크기 */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <!-- 게임 UI 요소 -->
    <div class="hud">
        <div class="hud-top">
            <div class="score">점수: <span id="score">0</span></div>
            <div class="combo hidden" id="comboContainer">
                <span id="comboCount">0</span> 콤보!
            </div>
            <div class="timer">시간: <span id="gameTimer">0</span>초</div>
        </div>
        
        <div class="hud-bottom">
            <div class="health">
                <span class="heart">❤️</span>
                <span class="heart">❤️</span>
                <span class="heart">❤️</span>
            </div>
            <div class="stage-indicator">
                <span id="currentStage">교양관</span>
                <div class="stage-progress">
                    <div class="progress-bar" id="stageProgress"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 캔버스 게임 화면 -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- 특수 이벤트 표시 영역 -->
    <div class="event-notification" id="eventNotification">
        <div class="event-content" id="eventContent"></div>
    </div>
    
    <!-- 게임 시작 카운트다운 -->
    <div class="countdown" id="countdown">
        <span id="countdownNumber">3</span>
    </div>
    
    <!-- 방향 전환 안내 (모바일 세로 모드) -->
    <div class="orientation-message" id="orientationMessage" style="display: none;">
        <div class="icon">📱</div>
        <div class="text">화면을 가로로 돌려주세요!</div>
        <div class="subtext">최상의 게임 경험을 위해 가로 방향을 권장합니다.</div>
    </div>
    
    <!-- 게임 오버 화면 -->
    <div class="game-over hidden" id="gameOver">
        <div class="game-over-content">
            <div class="game-stats">
                <h2 id="gameOverTitle">게임 오버!</h2>
                <p>최종 점수: <span id="finalScore">0</span></p>
                <p>플레이 시간: <span id="finalTime">0</span>초</p>
                <p>스테이지: <span id="finalStage">교양관</span></p>
                
                <div class="achievement-unlocked hidden" id="achievementContainer">
                    <h3>업적 달성!</h3>
                    <div id="achievementsList"></div>
                </div>
            </div>

            <div class="game-inputs">
                <!-- 이름 입력창 및 저장 버튼 -->
                <div class="nickname-save-container">
                    <div class="retro-input-group">
                        <div class="retro-input-label">YOUR NAME?</div>
                        <div class="retro-input-wrapper">
                            <input type="text" id="gameOverNickname" maxlength="12" placeholder="익명의 학생">
                            <button id="saveNicknameBtn" class="retro-button">SAVE</button>
                        </div>
                        <div class="retro-hint">* 미입력시 '익명의 학생'으로 저장됩니다</div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="restartButton" class="btn-restart">다시 시작</button>
                    <a href="{% url 'game:leaderboard' %}" class="btn-leaderboard">리더보드</a>
                    <a href="{% url 'game:index' %}" class="btn-home">홈으로</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 게임 클리어 화면 -->
    <div class="game-clear hidden" id="gameClear">
        <div class="game-over-content">
            <div class="game-stats">
                <h2>축하합니다! 졸업이다!</h2>
                <p>최종 점수: <span id="clearScore">0</span></p>
                <p>플레이 시간: <span id="clearTime">0</span>초</p>
                
                <div class="achievement-unlocked hidden" id="clearAchievementContainer">
                    <h3>업적 달성!</h3>
                    <div id="clearAchievementsList"></div>
                </div>
            </div>
            
            <div class="game-inputs">
                <div class="action-buttons">
                    <button id="clearRestartButton" class="btn-restart">다시 시작</button>
                    <a href="{% url 'game:leaderboard' %}" class="btn-leaderboard">리더보드</a>
                    <a href="{% url 'game:index' %}" class="btn-home">홈으로</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 캐릭터 및 게임 에셋 데이터 -->
<div id="gameAssets" 
     data-player-id="{{ player_id }}"
     data-outfit="{{ customization.outfit }}"
     data-hat="{{ customization.hat }}"
     data-shoes="{{ customization.shoes }}">
</div>
{% endblock %}

{% block dev_template_name %}game.html{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "VideoGame",
  "name": "Boo의 졸업 대모험",
  "url": "https://boogame.kr/game/play/",
  "description": "외대생 Boo가 졸업을 향해 장애물을 극복하는 웹 게임",
  "genre": ["Platform", "Arcade", "Casual"],
  "gamePlatform": "Web Browser",
  "applicationCategory": "Game",
  "operatingSystem": "Any",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "KRW",
    "availability": "http://schema.org/InStock"
  }
}
</script>
{% endblock %}

{% block scripts %}
<script>
  window.PLAYER_ID = "{{ player_id|default:'' }}";
  
  // 모바일 터치 이벤트 최적화
  document.addEventListener('DOMContentLoaded', function() {
    // iOS에서 더블 탭 방지
    document.addEventListener('touchmove', function(e) {
      if (e.scale !== 1) {
        e.preventDefault();
      }
    }, { passive: false });
    
    // 화면 방향 확인 및 메시지 표시
    function checkOrientation() {
      const orientationMessage = document.getElementById('orientationMessage');
      const gameInstance = window.gameInstance; // 게임 인스턴스 참조
      
      // 모바일 기기 확인 (가로 크기가 800px 이하)
      if (window.innerWidth <= 800) {
        // 세로 모드 확인 (가로 < 세로)
        const isLandscape = window.innerWidth >= window.innerHeight;
        
        if (!isLandscape) {
          // 세로 모드일 때 안내 메시지 표시
          if (orientationMessage) orientationMessage.style.display = 'flex';
        } else {
          // 가로 모드일 때 안내 메시지 숨김
          if (orientationMessage) orientationMessage.style.display = 'none';
          
          // 가로 모드에서 게임이 진행 중이면 캔버스 크기 업데이트 시도
          if (gameInstance && typeof gameInstance.updateCanvasSize === 'function') {
            gameInstance.updateCanvasSize();
            
            // 게임 오버 상태라면 레이아웃도 업데이트
            if (gameInstance.gameOver) {
              gameInstance.setupGameOverLayout();
            }
          }
        }
      } else {
        // 데스크톱에서는 방향 메시지 숨김
        if (orientationMessage) orientationMessage.style.display = 'none';
      }
      
      // 높이가 매우 작은 경우 (가로 모드이지만 폰트 크기 축소 필요한 경우)
      if (window.innerHeight < 400) {
        document.body.classList.add('very-small-height');
      } else {
        document.body.classList.remove('very-small-height');
      }
    }
    
    // 초기 방향 확인
    checkOrientation();
    
    // 방향 변경 이벤트 리스너
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', function() {
      // iOS에서는 방향 변경 후 지연이 있을 수 있으므로 약간의 지연 후 체크
      setTimeout(checkOrientation, 300);
    });
    
    // 게임 오버 화면에서 터치 스크롤 허용
    const gameOverElement = document.getElementById('gameOver');
    const gameOverContent = document.querySelector('.game-over-content');
    
    if (gameOverElement) {
      gameOverElement.addEventListener('touchmove', function(e) {
        e.stopPropagation();
      }, { passive: true });
    }
    
    if (gameOverContent) {
      gameOverContent.addEventListener('touchmove', function(e) {
        e.stopPropagation();
      }, { passive: true });
    }
    
    // iOS에서 입력 필드 포커스 시 처리
    const nicknameInput = document.getElementById('gameOverNickname');
    if (nicknameInput) {
      nicknameInput.addEventListener('focus', function() {
        // iOS에서는 포커스 시 위치 조정이 필요할 수 있음
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
          setTimeout(function() {
            // 입력 필드가 화면에 보이도록 스크롤
            nicknameInput.scrollIntoView({behavior: 'smooth', block: 'center'});
            
            // iOS에서는 스크롤이 제대로 작동하지 않을 수 있으므로 위치 직접 조정 
            const scrollContainer = document.querySelector('.game-over');
            if (scrollContainer) {
              scrollContainer.scrollTop = nicknameInput.offsetTop - 100;
            }
          }, 300);
        }
      });
    }
  });
</script>
<script src="{% static 'js/game.js' %}"></script>
{% endblock %}